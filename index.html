<!DOCTYPE html>

<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Ø®Ù…Ù‘Ù† ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ø§Ù„ÙØ© ğŸ­</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
:root {
  --bg:#0f0f15; --card:#17171f; --card2:#1e1e2a;
  --text:#f0ede8; --muted:#666; --accent:#ff6b35;
  --teal:#4ecdc4; --yellow:#ffe66d; --border:#2a2a38;
}
body {
  font-family:'Tajawal',sans-serif; background:var(--bg); color:var(--text);
  min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px;
  background-image: radial-gradient(ellipse at 15% 15%,rgba(255,107,53,.06) 0%,transparent 55%),
                    radial-gradient(ellipse at 85% 85%,rgba(78,205,196,.06) 0%,transparent 55%);
}
.screen { display:none; width:100%; max-width:480px; }
.screen.on { display:block; animation:up .4s ease; }
@keyframes up { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
@keyframes pop { 0%{transform:scale(.85);opacity:0} 70%{transform:scale(1.04)} 100%{transform:scale(1);opacity:1} }
@keyframes spin { to{transform:rotate(360deg)} }

.card {
background:var(â€“card); border-radius:26px; padding:30px 26px;
box-shadow:0 10px 50px rgba(0,0,0,.5); border:1px solid var(â€“border);
position:relative; overflow:hidden;
}
.card::before {
content:â€™â€™; position:absolute; top:0; left:0; right:0; height:3px;
background:linear-gradient(90deg,var(â€“accent),var(â€“teal));
}
.hero { text-align:center; margin-bottom:26px; }
.hero .icon { font-size:56px; display:block; margin-bottom:10px; }
.hero h1 {
font-size:25px; font-weight:900; margin:0;
background:linear-gradient(135deg,var(â€“accent),var(â€“teal));
-webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
}
.hero p { color:var(â€“muted); font-size:13px; margin-top:6px; }

.field { margin-bottom:14px; }
.field label { display:block; font-size:11px; font-weight:700; color:var(â€“muted); margin-bottom:7px; text-transform:uppercase; letter-spacing:.6px; }
input[type=text], textarea {
width:100%; padding:13px 15px; background:var(â€“card2); border:2px solid var(â€“border);
border-radius:13px; color:var(â€“text); font-family:â€˜Tajawalâ€™,sans-serif;
font-size:15px; outline:none; direction:rtl; transition:border-color .2s; box-sizing:border-box;
}
input[type=text]:focus, textarea:focus { border-color:var(â€“accent); }
textarea { min-height:120px; resize:vertical; line-height:1.75; }

.btn {
width:100%; padding:14px; border:none; border-radius:15px;
font-family:â€˜Tajawalâ€™,sans-serif; font-size:16px; font-weight:700;
cursor:pointer; transition:all .18s; margin-top:8px; display:block;
}
.btn-p { background:linear-gradient(135deg,var(â€“accent),#ff8c5a); color:#fff; }
.btn-p:active { transform:scale(.97); }
.btn-s { background:var(â€“card2); color:var(â€“teal); border:2px solid var(â€“border); }
.btn-s:active { transform:scale(.97); }
.btn-g { background:none; color:var(â€“muted); border:none; font-size:13px; padding:10px; width:auto; margin:6px auto 0; display:block; cursor:pointer; font-family:â€˜Tajawalâ€™,sans-serif; }
.btn:disabled { opacity:.45; cursor:not-allowed; }

.err {
background:rgba(231,76,60,.1); border:1px solid rgba(231,76,60,.25);
color:#e74c3c; padding:10px 14px; border-radius:11px; font-size:13px;
text-align:center; margin-bottom:12px; display:none;
}
.hint-box {
background:rgba(78,205,196,.07); border:1px solid rgba(78,205,196,.18);
border-radius:11px; padding:11px 14px; font-size:13px; color:var(â€“teal); margin-bottom:14px;
}
.topbar {
display:flex; justify-content:space-between; align-items:center;
padding:9px 13px; background:var(â€“card2); border-radius:11px;
margin-bottom:18px; border:1px solid var(â€“border);
}
.badge { background:rgba(255,107,53,.15); color:var(â€“accent); padding:3px 12px; border-radius:20px; font-size:12px; font-weight:700; }

.code-box {
background:var(â€“card2); border:2px solid var(â€“yellow); border-radius:18px;
padding:20px; text-align:center; margin-bottom:20px; position:relative;
}
.code-box .lbl { font-size:11px; color:var(â€“muted); margin-bottom:6px; }
.code-box .code { font-size:42px; font-weight:900; letter-spacing:10px; color:var(â€“yellow); }
.copy-btn {
position:absolute; top:10px; left:10px; background:var(â€“border);
border:none; color:var(â€“muted); padding:5px 11px; border-radius:7px;
font-size:12px; cursor:pointer; font-family:â€˜Tajawalâ€™,sans-serif; transition:all .2s;
}
.copy-btn:hover { background:var(â€“yellow); color:#000; }

.prow {
display:flex; align-items:center; gap:12px; padding:11px 14px;
background:var(â€“card2); border-radius:12px; border:1px solid var(â€“border);
margin-bottom:8px; animation:pop .3s ease;
}
.prow .av {
width:36px; height:36px; border-radius:50%; flex-shrink:0;
background:linear-gradient(135deg,var(â€“accent),var(â€“teal));
display:flex; align-items:center; justify-content:center; font-size:18px;
}
.prow .nm { font-weight:700; font-size:14px; }
.prow .st { margin-right:auto; font-size:11px; }

.story-box {
background:var(â€“card2); border-radius:16px; padding:22px 18px 18px;
border:1px solid var(â€“border); font-size:16px; line-height:1.85;
margin-bottom:22px; position:relative;
}
.story-box .qq {
font-size:50px; color:rgba(255,107,53,.12);
position:absolute; top:-4px; left:12px; line-height:1; font-family:Georgia,serif;
}

.opts { display:flex; flex-direction:column; gap:9px; margin-bottom:16px; }
.opt {
background:var(â€“card2); border:2px solid var(â€“border); border-radius:13px;
padding:13px 15px; display:flex; align-items:center; gap:13px;
cursor:pointer; transition:all .18s; font-family:â€˜Tajawalâ€™,sans-serif;
font-size:15px; font-weight:600; color:var(â€“text); text-align:right; width:100%;
}
.opt:hover:not([disabled]) { border-color:var(â€“teal); background:rgba(78,205,196,.07); }
.opt:active:not([disabled]) { transform:scale(.97); }
.opt .num {
min-width:30px; height:30px; border-radius:8px; background:var(â€“border);
display:flex; align-items:center; justify-content:center;
font-size:13px; font-weight:900; color:var(â€“muted); flex-shrink:0;
}
.opt.correct { border-color:var(â€“teal)!important; background:rgba(78,205,196,.12)!important; color:var(â€“teal)!important; }
.opt.wrong   { border-color:#e74c3c!important; background:rgba(231,76,60,.1)!important; color:#e74c3c!important; }
.opt.reveal  { border-color:var(â€“teal)!important; background:rgba(78,205,196,.05)!important; }
.opt[disabled] { cursor:default; }

.toast {
padding:13px 16px; border-radius:13px; text-align:center;
font-size:15px; font-weight:700; margin-bottom:14px; animation:pop .3s ease;
}
.toast.win  { background:rgba(78,205,196,.14); color:var(â€“teal); border:1px solid rgba(78,205,196,.3); }
.toast.lose { background:rgba(231,76,60,.12); color:#e74c3c; border:1px solid rgba(231,76,60,.2); }

.waiting { text-align:center; padding:20px 0; }
.spinner { width:30px; height:30px; border:3px solid var(â€“border); border-top-color:var(â€“accent); border-radius:50%; animation:spin .8s linear infinite; margin:0 auto 12px; }
.waiting p { color:var(â€“muted); font-size:14px; }

.srow {
display:flex; align-items:center; gap:13px; padding:13px 15px;
background:var(â€“card2); border-radius:13px; border:1px solid var(â€“border);
margin-bottom:8px; animation:pop .4s ease both;
}
.srow:first-child { background:rgba(255,230,109,.05); border-color:rgba(255,230,109,.25); }
.srow .medal { font-size:22px; min-width:28px; text-align:center; }
.srow .sname { font-weight:700; font-size:15px; flex:1; }
.srow .pts { background:rgba(255,107,53,.18); color:var(â€“accent); padding:4px 13px; border-radius:20px; font-size:13px; font-weight:700; }
.srow:first-child .pts { background:rgba(255,230,109,.18); color:var(â€“yellow); }

.name-tag { display:inline-flex; align-items:center; gap:6px; background:rgba(255,107,53,.12); color:var(â€“accent); padding:4px 13px; border-radius:20px; font-size:13px; font-weight:700; margin-bottom:12px; }
.sec-title { font-size:11px; font-weight:700; color:var(â€“muted); text-transform:uppercase; letter-spacing:.6px; margin-bottom:10px; }
.or-div { display:flex; align-items:center; gap:10px; margin:16px 0; color:var(â€“muted); font-size:12px; }
.or-div::before,.or-div::after { content:â€™â€™; flex:1; height:1px; background:var(â€“border); }
</style>

</head>
<body>

<!-- HOME -->

<div id="s-home" class="screen on">
<div class="card">
  <div class="hero">
    <span class="icon">ğŸ­</span>
    <h1>Ø®Ù…Ù‘Ù† ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ø§Ù„ÙØ©</h1>
    <p>ÙƒÙ„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø¬ÙˆØ§Ù„Ù‡ â€” ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙŠÙƒØªØ¨ Ø³Ø§Ù„ÙØªÙ‡!</p>
  </div>
  <div class="field">
    <label>Ø§Ø³Ù…Ùƒ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©</label>
    <input type="text" id="nameIn" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ..." maxlength="18" onkeydown="if(event.key==='Enter')tryCreate()">
  </div>
  <div class="err" id="homeErr"></div>
  <button class="btn btn-p" onclick="tryCreate()">ğŸ  Ø£Ù†Ø´Ø¦ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
  <div class="or-div">Ø£Ùˆ</div>
  <div class="field">
    <label>Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</label>
    <input type="text" id="codeIn" placeholder="Ù…Ø«Ù„: 4829" maxlength="4"
      style="text-align:center;font-size:26px;letter-spacing:8px;font-weight:900"
      oninput="this.value=this.value.replace(/\D/g,'')">
  </div>
  <button class="btn btn-s" onclick="tryJoin()">ğŸšª Ø§Ø¯Ø®Ù„ Ø§Ù„ØºØ±ÙØ©</button>
</div>
</div>

<!-- LOBBY -->

<div id="s-lobby" class="screen">
<div class="card">
  <div class="code-box">
    <div class="lbl">Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© â€” Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ğŸ‘‡</div>
    <div class="code" id="lobbyCode"></div>
    <button class="copy-btn" id="copyBtn" onclick="copyCode()">Ù†Ø³Ø®</button>
  </div>
  <div class="sec-title">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</div>
  <div id="lobbyPlayers"></div>
  <div class="err" id="lobbyErr"></div>
  <div id="startArea"></div>
</div>
</div>

<!-- WRITE -->

<div id="s-write" class="screen">
<div class="card">
  <div class="topbar">
    <span style="font-size:13px;color:var(--muted)">Ø§ÙƒØªØ¨ Ø³Ø§Ù„ÙØªÙƒ</span>
    <span class="badge" id="writeProg"></span>
  </div>
  <div class="name-tag">ğŸ‘¤ <span id="writeName"></span></div>
  <div class="hint-box">ğŸ’¡ Ø§ÙƒØªØ¨ Ø³Ø§Ù„ÙØ© Ø­ØµÙ„Øª Ù…Ø¹Ùƒ Ø¨Ø¯ÙˆÙ† Ù…Ø§ ØªØ°ÙƒØ± Ø§Ø³Ù…Ùƒ!</div>
  <div class="field">
    <label>Ø³Ø§Ù„ÙØªÙƒ</label>
    <textarea id="storyIn" placeholder="ÙƒØ§Ù† ÙŠÙˆÙ… Ø¹Ø§Ø¯ÙŠ ÙˆØ£Ù†Ø§..."></textarea>
  </div>
  <div class="err" id="writeErr"></div>
  <div id="writeArea">
    <button class="btn btn-p" onclick="submitStory()">Ø¥Ø±Ø³Ø§Ù„ âœ“</button>
  </div>
</div>
</div>

<!-- GUESS -->

<div id="s-guess" class="screen">
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <span id="roundBadge" style="background:rgba(255,107,53,.15);color:var(--accent);padding:5px 14px;border-radius:20px;font-size:13px;font-weight:700"></span>
    <span id="guessCount" style="font-size:12px;color:var(--muted)"></span>
  </div>
  <div class="story-box">
    <span class="qq">â</span>
    <div id="storyTxt" style="padding-top:6px"></div>
  </div>
  <div class="sec-title">Ù…ÙŠÙ† ØµØ§Ø­Ø¨ Ù‡Ø§Ù„Ø³Ø§Ù„ÙØ©ØŸ</div>
  <div class="opts" id="optsList"></div>
  <div id="guessToast" style="display:none"></div>
  <div id="nextArea"></div>
</div>
</div>

<!-- SCORES -->

<div id="s-scores" class="screen">
<div class="card">
  <div style="text-align:center;margin-bottom:24px">
    <div style="font-size:58px;margin-bottom:8px">ğŸ†</div>
    <h1 style="font-size:24px;font-weight:900;margin:0;background:linear-gradient(135deg,var(--accent),var(--yellow));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h1>
    <p style="color:var(--muted);font-size:14px;margin-top:6px" id="winnerTxt"></p>
  </div>
  <div id="scoresList"></div>
  <div id="scoresActions"></div>
</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG - Ø¹Ø¯Ù‘Ù„ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ³ÙˆÙŠ Ø­Ø³Ø§Ø¨ JSONBin
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1. Ø±ÙˆØ­ jsonbin.io ÙˆØ³Ø¬Ù‘Ù„ Ø­Ø³Ø§Ø¨ Ù…Ø¬Ø§Ù†ÙŠ
// 2. Ø§Ø¶ØºØ· "Create Bin" ÙˆØ­Ø· {} ÙˆØ§Ù†Ø³Ø® Ø§Ù„Ù€ BIN ID
// 3. Ù…Ù† API Keys Ø§Ù†Ø³Ø® Ø§Ù„Ù€ Master Key
// 4. Ø§Ø­Ø· Ø§Ù„Ù‚ÙŠÙ… Ù‡Ù†Ø§:
const JSONBIN_API_KEY = 'YOUR_API_KEY_HERE';
const JSONBIN_BIN_ID  = 'YOUR_BIN_ID_HERE';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const AVATARS = ['ğŸ˜','ğŸ¤©','ğŸ˜‚','ğŸ¥³','ğŸ˜','ğŸ¤”','ğŸ˜œ','ğŸ™ƒ','ğŸ¦Š','ğŸ¯'];
let myName = '', myRoom = '', amHost = false;
let pollTimer = null;
let lastPhase = '', lastStory = -1, iGuessed = false;
let myShuffledOpts = [];

// â”€â”€ helpers â”€â”€
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('on'));
  document.getElementById(id).classList.add('on');
  window.scrollTo(0,0);
}
function showErr(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg; el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}
function waiting(msg) {
  return `<div class="waiting"><div class="spinner"></div><p>${msg}</p></div>`;
}

// â”€â”€ JSONBin API â”€â”€
async function dbGet() {
  try {
    const r = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
      headers: { 'X-Master-Key': JSONBIN_API_KEY }
    });
    const j = await r.json();
    return j.record || {};
  } catch { return {}; }
}

async function dbSet(data) {
  try {
    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
      method: 'PUT',
      headers: { 'Content-Type':'application/json', 'X-Master-Key': JSONBIN_API_KEY },
      body: JSON.stringify(data)
    });
  } catch(e) { console.error(e); }
}

async function getRooms() { const d = await dbGet(); return d.rooms || {}; }
async function getRoom(code) { const rooms = await getRooms(); return rooms[code] || null; }
async function setRoom(code, room) {
  const d = await dbGet();
  if (!d.rooms) d.rooms = {};
  d.rooms[code] = room;
  await dbSet(d);
}

// â”€â”€ CREATE â”€â”€
async function tryCreate() {
  const name = document.getElementById('nameIn').value.trim();
  if (!name) { showErr('homeErr','âš ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹'); return; }

  if (JSONBIN_API_KEY === 'YOUR_API_KEY_HERE') {
    showErr('homeErr','âš ï¸ Ù„Ø§Ø²Ù… ØªØ¶ÙŠÙ API Key Ù…Ù† JSONBin Ø£ÙˆÙ„Ø§Ù‹! Ø´ÙˆÙ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.');
    return;
  }

  const code = Math.floor(1000 + Math.random() * 9000).toString();
  const room = {
    code, host: name, phase: 'lobby',
    players: [{ name, avatar: AVATARS[0], wrote: false }],
    stories: [], shuffled: [], scores: { [name]: 0 },
    currentStory: 0, guesses: {}, created: Date.now()
  };
  await setRoom(code, room);
  myName = name; myRoom = code; amHost = true;
  renderLobby(room);
  show('s-lobby');
  startPoll();
}

// â”€â”€ JOIN â”€â”€
async function tryJoin() {
  const name = document.getElementById('nameIn').value.trim();
  const code = document.getElementById('codeIn').value.trim();
  if (!name) { showErr('homeErr','âš ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  if (code.length !== 4) { showErr('homeErr','âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© (4 Ø£Ø±Ù‚Ø§Ù…)'); return; }

  const room = await getRoom(code);
  if (!room) { showErr('homeErr','âŒ Ø§Ù„ØºØ±ÙØ© Ù…Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©'); return; }
  if (room.phase !== 'lobby') { showErr('homeErr','âš ï¸ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª'); return; }
  if (room.players.find(p => p.name === name)) { showErr('homeErr','âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ØŒ ØºÙŠÙ‘Ø± Ø§Ø³Ù…Ùƒ'); return; }

  const avatar = AVATARS[room.players.length % AVATARS.length];
  room.players.push({ name, avatar, wrote: false });
  room.scores[name] = 0;
  await setRoom(code, room);

  myName = name; myRoom = code; amHost = false;
  renderLobby(room);
  show('s-lobby');
  startPoll();
}

// â”€â”€ LOBBY â”€â”€
function renderLobby(room) {
  document.getElementById('lobbyCode').textContent = room.code;
  const cont = document.getElementById('lobbyPlayers');
  cont.innerHTML = '';
  room.players.forEach(p => {
    const d = document.createElement('div');
    d.className = 'prow';
    d.innerHTML = `<div class="av">${p.avatar}</div>
      <div class="nm">${p.name}</div>
      <div class="st" style="color:${p.name===room.host?'#ffe66d':'#4ecdc4'}">
        ${p.name===room.host?'ğŸ‘‘ Ù…Ø¶ÙŠÙ':'âœ… Ø¬Ø§Ù‡Ø²'}
      </div>`;
    cont.appendChild(d);
  });

  const area = document.getElementById('startArea');
  if (amHost) {
    const ok = room.players.length >= 2;
    area.innerHTML = `<button class="btn btn-p" onclick="startGame()" ${ok?'':'disabled'}>
      ${ok ? `ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© (${room.players.length} Ù„Ø§Ø¹Ø¨ÙŠÙ†)` : 'â³ Ø§Ù†ØªØ¸Ø± Ù„Ø§Ø¹Ø¨ Ø«Ø§Ù†ÙŠ...'}
    </button>`;
  } else {
    area.innerHTML = waiting('Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©...');
  }
}

async function startGame() {
  const room = await getRoom(myRoom);
  room.phase = 'writing';
  room.stories = []; room.shuffled = []; room.guesses = {}; room.currentStory = 0;
  room.players.forEach(p => { p.wrote = false; room.scores[p.name] = 0; });
  await setRoom(myRoom, room);
}

function copyCode() {
  navigator.clipboard.writeText(myRoom).then(() => {
    document.getElementById('copyBtn').textContent = 'âœ“ ØªÙ…';
    setTimeout(() => document.getElementById('copyBtn').textContent = 'Ù†Ø³Ø®', 2000);
  });
}

// â”€â”€ WRITE â”€â”€
function showWriteScreen(room) {
  const total = room.players.length;
  const done = room.stories.length;
  document.getElementById('writeName').textContent = myName;
  document.getElementById('writeProg').textContent = `${done + 1} / ${total}`;
  document.getElementById('storyIn').value = '';
  document.getElementById('writeArea').innerHTML = `<button class="btn btn-p" onclick="submitStory()">Ø¥Ø±Ø³Ø§Ù„ âœ“</button>`;
  show('s-write');
}

async function submitStory() {
  const text = document.getElementById('storyIn').value.trim();
  if (text.length < 10) { showErr('writeErr','âš ï¸ Ø§ÙƒØªØ¨ Ø³Ø§Ù„ÙØ© Ø£Ø·ÙˆÙ„ Ø´ÙˆÙŠ!'); return; }

  const room = await getRoom(myRoom);
  room.stories.push({ player: myName, text });
  const me = room.players.find(p => p.name === myName);
  if (me) me.wrote = true;
  await setRoom(myRoom, room);

  document.getElementById('writeArea').innerHTML = waiting('ØªÙ…! Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù‚ÙŠØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...');
}

// â”€â”€ GUESS â”€â”€
function showGuessScreen(room) {
  iGuessed = false;
  const idx = room.currentStory;
  const story = room.shuffled[idx];
  const total = room.shuffled.length;
  const myGuess = room.guesses?.[idx]?.[myName];
  const correct = story.player;
  const voters = room.players.length - 1;
  const guessCount = Object.keys(room.guesses?.[idx] || {}).length;

  document.getElementById('roundBadge').textContent = `Ø³Ø§Ù„ÙØ© ${idx+1} Ù…Ù† ${total}`;
  document.getElementById('guessCount').textContent = myGuess ? `Ø®Ù…Ù‘Ù† ${guessCount}/${voters}` : '';
  document.getElementById('storyTxt').textContent = story.text;
  document.getElementById('guessToast').style.display = 'none';
  document.getElementById('nextArea').innerHTML = '';

  // Shuffle options once per round
  if (!myShuffledOpts.length || lastStory !== idx) {
    myShuffledOpts = [...room.players].sort(() => Math.random() - .5);
  }

  const grid = document.getElementById('optsList');
  grid.innerHTML = '';
  myShuffledOpts.forEach((p, i) => {
    const btn = document.createElement('button');
    btn.className = 'opt';
    btn.dataset.name = p.name;
    btn.innerHTML = `<span class="num">${i+1}</span>${p.name}`;
    if (myGuess) {
      btn.disabled = true;
      if (p.name === correct) btn.classList.add(myGuess === correct ? 'correct' : 'reveal');
      if (p.name === myGuess && myGuess !== correct) btn.classList.add('wrong');
    } else {
      btn.onclick = () => makeGuess(p.name, correct, idx);
    }
    grid.appendChild(btn);
  });

  if (myGuess) {
    showToast(myGuess, correct);
    showNextBtn(room, idx);
    iGuessed = true;
  }

  show('s-guess');
}

async function makeGuess(guessed, correct, idx) {
  if (iGuessed) return;
  iGuessed = true;

  document.querySelectorAll('.opt').forEach(b => {
    b.disabled = true;
    if (b.dataset.name === correct && guessed !== correct) b.classList.add('reveal');
    if (b.dataset.name === guessed) b.classList.add(guessed === correct ? 'correct' : 'wrong');
    if (b.dataset.name === correct && guessed === correct) b.classList.add('correct');
  });

  showToast(guessed, correct);

  const room = await getRoom(myRoom);
  if (!room.guesses[idx]) room.guesses[idx] = {};
  room.guesses[idx][myName] = guessed;
  if (guessed === correct && myName !== correct) {
    room.scores[myName] = (room.scores[myName] || 0) + 1;
  }
  await setRoom(myRoom, room);
  showNextBtn(room, idx);
}

function showToast(guessed, correct) {
  const t = document.getElementById('guessToast');
  t.className = 'toast ' + (guessed === correct ? 'win' : 'lose');
  t.textContent = guessed === correct
    ? `âœ… ØµØ­! Ø§Ù„Ø³Ø§Ù„ÙØ© Ù„Ù€ ${correct} ğŸ‰`
    : `âŒ ØºÙ„Ø·! ÙƒØ§Ù†Øª Ù„Ù€ ${correct} ğŸ˜…`;
  t.style.display = 'block';
}

function showNextBtn(room, idx) {
  const area = document.getElementById('nextArea');
  const voters = room.players.length - 1;
  const guessCount = Object.keys(room.guesses?.[idx] || {}).length;
  const isLast = idx + 1 >= room.shuffled.length;

  if (amHost) {
    area.innerHTML = `<button class="btn btn-p" onclick="nextRound()">
      ${isLast ? 'ğŸ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬' : 'Ø§Ù„ØªØ§Ù„ÙŠ â†'}
    </button>`;
  } else if (guessCount >= voters) {
    area.innerHTML = waiting('Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ ÙŠÙ†ØªÙ‚Ù„...');
  } else {
    area.innerHTML = waiting(`Ø®Ù…Ù‘Ù† ${guessCount} Ù…Ù† ${voters}...`);
  }
}

async function nextRound() {
  if (!amHost) return;
  const room = await getRoom(myRoom);
  const next = room.currentStory + 1;
  if (next >= room.shuffled.length) room.phase = 'scores';
  else { room.currentStory = next; }
  await setRoom(myRoom, room);
}

// â”€â”€ SCORES â”€â”€
function showScores(room) {
  stopPoll();
  const sorted = Object.entries(room.scores).sort((a,b) => b[1]-a[1]);
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const winner = sorted[0]?.[0];
  document.getElementById('winnerTxt').textContent = winner ? `ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø²: ${winner}!` : '';

  const list = document.getElementById('scoresList');
  list.innerHTML = '';
  sorted.forEach(([name, pts], i) => {
    const d = document.createElement('div');
    d.className = 'srow';
    d.style.animationDelay = `${i*.08}s`;
    d.innerHTML = `<span class="medal">${medals[i]||'ğŸ–ï¸'}</span>
      <span class="sname">${name}</span>
      <span class="pts">${pts} Ù†Ù‚Ø·Ø©</span>`;
    list.appendChild(d);
  });

  const area = document.getElementById('scoresActions');
  if (amHost) {
    area.innerHTML = `<button class="btn btn-p" onclick="playAgain()">ğŸ” Ø¬ÙˆÙ„Ø© Ø«Ø§Ù†ÙŠØ©</button>`;
  } else {
    area.innerHTML = waiting('Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...');
  }
  area.innerHTML += `<button class="btn btn-g" onclick="goHome()">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>`;

  show('s-scores');
}

async function playAgain() {
  const room = await getRoom(myRoom);
  room.phase = 'lobby'; room.stories = []; room.shuffled = [];
  room.guesses = {}; room.currentStory = 0;
  room.players.forEach(p => { p.wrote = false; room.scores[p.name] = 0; });
  await setRoom(myRoom, room);
  lastPhase = ''; lastStory = -1; iGuessed = false; myShuffledOpts = [];
  renderLobby(room);
  show('s-lobby');
  startPoll();
}

function goHome() {
  stopPoll();
  myName=''; myRoom=''; amHost=false;
  lastPhase=''; lastStory=-1; iGuessed=false; myShuffledOpts=[];
  show('s-home');
}

// â”€â”€ POLL â”€â”€
function startPoll() {
  stopPoll();
  pollTimer = setInterval(poll, 3000);
}
function stopPoll() {
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}

async function poll() {
  const room = await getRoom(myRoom);
  if (!room) return;

  // LOBBY
  if (room.phase === 'lobby') {
    if (document.getElementById('s-lobby').classList.contains('on')) renderLobby(room);
    return;
  }

  // WRITING
  if (room.phase === 'writing') {
    const me = room.players.find(p => p.name === myName);
    if (!me?.wrote) {
      if (!document.getElementById('s-write').classList.contains('on')) showWriteScreen(room);
    } else {
      if (document.getElementById('s-write').classList.contains('on')) {
        const done = room.stories.length;
        const total = room.players.length;
        document.getElementById('writeArea').innerHTML = waiting(`ÙƒØªØ¨ ${done} Ù…Ù† ${total}...`);
      }
      // host triggers start of guessing
      if (amHost && room.players.every(p => p.wrote)) {
        const fresh = await getRoom(myRoom);
        if (fresh.phase === 'writing' && fresh.players.every(p => p.wrote)) {
          fresh.shuffled = [...fresh.stories].sort(() => Math.random() - .5);
          fresh.currentStory = 0;
          fresh.phase = 'guessing';
          fresh.guesses = {};
          await setRoom(myRoom, fresh);
        }
      }
    }
    return;
  }

  // GUESSING
  if (room.phase === 'guessing') {
    const idx = room.currentStory;
    const myGuess = room.guesses?.[idx]?.[myName];
    const storyOwner = room.shuffled[idx]?.player;

    if (idx !== lastStory) {
      lastStory = idx;
      iGuessed = false;
      myShuffledOpts = [];
      showGuessScreen(room);
      return;
    }

    // Update guess count live
    if (iGuessed || myName === storyOwner) {
      const voters = room.players.length - 1;
      const guessCount = Object.keys(room.guesses?.[idx] || {}).length;
      document.getElementById('guessCount').textContent = `Ø®Ù…Ù‘Ù† ${guessCount}/${voters}`;
      showNextBtn(room, idx);
    }
    return;
  }

  // SCORES
  if (room.phase === 'scores' && lastPhase !== 'scores') {
    lastPhase = 'scores';
    showScores(room);
  }
}
</script>

</body>
</html>
