<!DOCTYPE html>

<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø®Ù…Ù‘Ù† ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ø§Ù„ÙØ©</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --orange: #ff6b35; --teal: #4ecdc4; --yellow: #ffe66d;
    --bg: #0f0f15; --card: #16161f; --surface: #1e1e2e;
    --border: #2e2e45; --text: #f0ede8; --muted: #555;
  }
  body {
    font-family: 'Tajawal', sans-serif;
    background: var(--bg);
    background-image:
      radial-gradient(ellipse at 20% 20%, rgba(255,107,53,0.06) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 80%, rgba(78,205,196,0.06) 0%, transparent 60%);
    min-height: 100vh;
    display: flex; align-items: center; justify-content: center;
    padding: 16px; color: var(--text); direction: rtl;
  }
  .wrap { width: 100%; max-width: 500px; }
  .card {
    background: var(--card); border-radius: 26px; padding: 32px 28px;
    box-shadow: 0 8px 40px rgba(0,0,0,0.5); border: 1px solid var(--border);
    position: relative; overflow: hidden; animation: fadeUp 0.4s ease;
  }
  .card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    background: linear-gradient(90deg, var(--orange), var(--teal));
  }
  .screen { display: none; }
  .screen.active { display: block; }
  input, textarea {
    width: 100%; padding: 13px 16px; background: var(--surface);
    border: 2px solid var(--border); border-radius: 13px; color: var(--text);
    font-family: 'Tajawal', sans-serif; font-size: 16px; outline: none;
    direction: rtl; transition: border-color 0.2s;
  }
  input:focus, textarea:focus { border-color: var(--orange); }
  input::placeholder, textarea::placeholder { color: var(--muted); }
  textarea { min-height: 130px; resize: vertical; line-height: 1.7; }
  .btn {
    width: 100%; padding: 14px; border: none; border-radius: 15px;
    font-family: 'Tajawal', sans-serif; font-size: 17px; font-weight: 700;
    cursor: pointer; margin-top: 8px; transition: all 0.2s;
  }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-primary { background: linear-gradient(135deg, var(--orange), #ff8c5a); color: #fff; }
  .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(255,107,53,0.4); }
  .btn-secondary { background: var(--surface); color: var(--teal); border: 2px solid var(--border); }
  .btn-ghost { background: none; color: var(--muted); font-size: 14px; padding: 10px; width: auto; display: block; margin: 8px auto 0; }
  .label { display: block; font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
  .err { background: rgba(231,76,60,0.12); border: 1px solid rgba(231,76,60,0.3); color: #e74c3c; padding: 11px 15px; border-radius: 12px; font-size: 14px; text-align: center; margin-bottom: 12px; display: none; }
  .err.show { display: block; }
  .dots { display: flex; gap: 5px; justify-content: center; margin-bottom: 8px; }
  .dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 1.2s ease infinite; }
  .dot:nth-child(1) { background: var(--orange); animation-delay: 0s; }
  .dot:nth-child(2) { background: var(--teal); animation-delay: 0.2s; }
  .dot:nth-child(3) { background: var(--yellow); animation-delay: 0.4s; }
  .room-code-box { background: var(--surface); border: 2px solid var(--yellow); border-radius: 16px; padding: 18px; text-align: center; margin-bottom: 20px; position: relative; }
  .code-hint { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
  .code-num { font-size: 40px; font-weight: 900; letter-spacing: 10px; color: var(--yellow); }
  .copy-btn { position: absolute; top: 10px; left: 10px; background: var(--border); border: none; color: #888; padding: 5px 11px; border-radius: 7px; font-size: 12px; cursor: pointer; font-family: 'Tajawal', sans-serif; }
  .player-item { display: flex; align-items: center; gap: 12px; padding: 11px 15px; background: var(--surface); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 8px; animation: pop 0.3s ease; }
  .player-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--orange), var(--teal)); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
  .player-name { font-weight: 700; font-size: 15px; flex: 1; }
  .divider { display: flex; align-items: center; gap: 12px; margin: 18px 0; color: #444; font-size: 13px; }
  .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
  .story-card { background: var(--surface); border-radius: 16px; padding: 22px 18px; margin-bottom: 24px; border: 1px solid var(--border); font-size: 16px; line-height: 1.85; position: relative; }
  .story-quote { font-size: 50px; color: rgba(255,107,53,0.12); position: absolute; top: -6px; left: 12px; line-height: 1; font-family: Georgia, serif; }
  .story-text { padding-top: 8px; }
  .guess-btn { background: var(--surface); border: 2px solid var(--border); border-radius: 13px; padding: 13px 16px; display: flex; align-items: center; gap: 14px; cursor: pointer; font-family: 'Tajawal', sans-serif; font-size: 15px; font-weight: 600; color: var(--text); text-align: right; width: 100%; margin-bottom: 9px; transition: all 0.2s; animation: pop 0.3s ease both; }
  .guess-btn:hover:not(:disabled) { border-color: var(--orange); }
  .guess-btn:disabled { cursor: default; }
  .guess-btn.correct { border-color: var(--teal); background: rgba(78,205,196,0.1); color: var(--teal); }
  .guess-btn.wrong { border-color: #e74c3c; background: rgba(231,76,60,0.1); color: #e74c3c; }
  .guess-num { min-width: 30px; height: 30px; border-radius: 8px; background: var(--border); display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 900; color: var(--muted); flex-shrink: 0; }
  .toast { padding: 13px 18px; border-radius: 13px; text-align: center; font-size: 15px; font-weight: 700; margin-bottom: 14px; animation: pop 0.3s ease; display: none; }
  .toast.show { display: block; }
  .toast.win { background: rgba(78,205,196,0.14); color: var(--teal); border: 1px solid rgba(78,205,196,0.3); }
  .toast.lose { background: rgba(231,76,60,0.12); color: #e74c3c; border: 1px solid rgba(231,76,60,0.2); }
  .score-item { display: flex; align-items: center; gap: 14px; padding: 13px 16px; border-radius: 13px; border: 1px solid var(--border); margin-bottom: 10px; animation: pop 0.4s ease both; }
  .score-item.first { background: rgba(255,230,109,0.06); border-color: rgba(255,230,109,0.27); }
  .score-item:not(.first) { background: var(--surface); }
  .score-medal { font-size: 22px; min-width: 30px; text-align: center; }
  .score-name { font-weight: 700; font-size: 15px; flex: 1; }
  .score-pts { padding: 4px 14px; border-radius: 20px; font-size: 14px; font-weight: 700; }
  .score-item.first .score-pts { background: rgba(255,230,109,0.2); color: var(--yellow); }
  .score-item:not(.first) .score-pts { background: rgba(255,107,53,0.18); color: var(--orange); }
  .waiting { text-align: center; padding: 16px 0; }
  .waiting p { color: var(--muted); font-size: 14px; margin-top: 6px; }
  .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 13px; border-radius: 20px; font-size: 13px; font-weight: 700; margin-bottom: 14px; }
  .badge-orange { background: rgba(255,107,53,0.12); color: var(--orange); }
  .badge-teal { background: rgba(78,205,196,0.12); color: var(--teal); }
  .tip { background: rgba(78,205,196,0.08); border: 1px solid rgba(78,205,196,0.2); border-radius: 11px; padding: 11px 14px; font-size: 13px; color: var(--teal); margin-bottom: 16px; }
  .row { display: flex; justify-content: space-between; align-items: center; }
  .grad-title { background: linear-gradient(135deg, var(--orange), var(--teal)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .grad-title-gold { background: linear-gradient(135deg, var(--orange), var(--yellow)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .section-label { font-size: 12px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
  .round-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  @keyframes pop { 0%{transform:scale(0.85);opacity:0} 70%{transform:scale(1.04)} 100%{transform:scale(1);opacity:1} }
  @keyframes fadeUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>
<div class="wrap">

  <!-- HOME -->

  <div id="screen-home" class="screen card active">
    <div style="text-align:center;margin-bottom:28px">
      <div style="font-size:60px;margin-bottom:10px">ğŸ­</div>
      <h1 style="font-size:26px;font-weight:900;" class="grad-title">Ø®Ù…Ù‘Ù† ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ø§Ù„ÙØ©</h1>
      <p style="color:var(--muted);font-size:14px;margin-top:6px">ÙƒÙ„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø¬ÙˆØ§Ù„Ù‡ â€” ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙŠÙƒØªØ¨ Ø³Ø§Ù„ÙØªÙ‡!</p>
    </div>
    <div style="margin-bottom:16px">
      <label class="label">Ø§Ø³Ù…Ùƒ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©</label>
      <input id="home-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ..." maxlength="20">
    </div>
    <div class="err" id="home-err"></div>
    <button class="btn btn-primary" onclick="createRoom()">ğŸ  Ø£Ù†Ø´Ø¦ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
    <div class="divider">Ø£Ùˆ</div>
    <div style="margin-bottom:16px">
      <label class="label">Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</label>
      <input id="home-code" placeholder="Ù…Ø«Ù„: 4829" maxlength="4"
        style="text-align:center;font-size:26px;letter-spacing:8px;font-weight:900"
        oninput="this.value=this.value.replace(/\D/g,'')">
    </div>
    <button class="btn btn-secondary" onclick="joinRoom()">ğŸšª Ø§Ø¯Ø®Ù„ Ø§Ù„ØºØ±ÙØ©</button>
  </div>

  <!-- LOBBY -->

  <div id="screen-lobby" class="screen card">
    <div class="room-code-box">
      <div class="code-hint">Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© â€” Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</div>
      <div class="code-num" id="lobby-code">----</div>
      <button class="copy-btn" onclick="copyCode()" id="copy-btn">Ù†Ø³Ø®</button>
    </div>
    <div class="section-label">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† (<span id="lobby-count">0</span>)</div>
    <div id="lobby-players"></div>
    <div class="err" id="lobby-err"></div>
    <div id="lobby-host-area">
      <button class="btn btn-primary" id="start-btn" onclick="startGame()">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
    </div>
    <div id="lobby-wait-area" class="waiting" style="display:none">
      <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      <p>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©...</p>
    </div>
  </div>

  <!-- WRITE -->

  <div id="screen-write" class="screen card">
    <div class="row" style="padding:9px 14px;background:var(--surface);border-radius:11px;margin-bottom:20px;border:1px solid var(--border)">
      <span style="font-size:13px;color:var(--muted)">Ø§ÙƒØªØ¨ Ø³Ø§Ù„ÙØªÙƒ</span>
      <span class="badge badge-orange" style="margin:0">Ø¯ÙˆØ±Ùƒ! ğŸ‘‹</span>
    </div>
    <div class="badge badge-orange" id="write-name-badge">ğŸ‘¤ </div>
    <div class="tip">ğŸ’¡ Ø§ÙƒØªØ¨ Ø³Ø§Ù„ÙØ© Ø­ØµÙ„Øª Ù…Ø¹Ùƒ Ø¨Ø¯ÙˆÙ† Ù…Ø§ ØªØ°ÙƒØ± Ø§Ø³Ù…Ùƒ â€” Ø§Ù„Ø¨Ø§Ù‚ÙŠÙ† Ø±Ø§Ø­ ÙŠØ®Ù…Ù‘Ù†ÙˆÙ†!</div>
    <div id="write-input-area">
      <div style="font-size:13px;color:var(--orange);font-weight:700;margin-bottom:10px;text-align:center" id="write-story-counter">Ø§Ù„Ø³Ø§Ù„ÙØ© 1 Ù…Ù† 4</div>
      <textarea id="story-input" placeholder="ÙƒØ§Ù† ÙŠÙˆÙ… Ø¹Ø§Ø¯ÙŠ ÙˆØ£Ù†Ø§ Ø±Ø§ÙŠØ­..."></textarea>
      <div class="err" id="write-err"></div>
      <button class="btn btn-primary" onclick="submitStory()" id="submit-story-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø§Ù„ÙØ© âœ“</button>
    </div>
    <div id="write-wait-area" class="waiting" style="display:none">
      <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      <p id="write-wait-text">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„! Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù‚ÙŠØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</p>
    </div>
  </div>

  <!-- GUESS -->

  <div id="screen-guess" class="screen card">
    <div class="round-header">
      <span class="badge badge-orange" style="margin:0" id="guess-round-label">Ø³Ø§Ù„ÙØ© 1 Ù…Ù† 1</span>
      <span style="font-size:12px;color:var(--muted)" id="guess-vote-count"></span>
    </div>
    <div class="story-card">
      <div class="story-quote">â</div>
      <div class="story-text" id="guess-story-text"></div>
    </div>
    <div class="section-label">Ù…ÙŠÙ† ØµØ§Ø­Ø¨ Ù‡Ø§Ù„Ø³Ø§Ù„ÙØ©ØŸ</div>
    <div id="guess-options"></div>
    <div class="toast" id="guess-toast"></div>
    <div id="guess-next-host" style="display:none">
      <button class="btn btn-primary" onclick="nextRound()" id="next-btn">Ø§Ù„ØªØ§Ù„ÙŠ â†</button>
    </div>
    <div id="guess-next-wait" class="waiting" style="display:none">
      <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      <p>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ ÙŠÙ†ØªÙ‚Ù„ Ù„Ù„ØªØ§Ù„ÙŠ...</p>
    </div>
  </div>

  <!-- SCORES -->

  <div id="screen-scores" class="screen card">
    <div style="text-align:center;margin-bottom:24px">
      <div style="font-size:60px;margin-bottom:8px">ğŸ†</div>
      <h1 style="font-size:24px;font-weight:900;" class="grad-title-gold">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h1>
      <p style="color:var(--muted);margin-top:6px;font-size:14px" id="winner-line"></p>
    </div>
    <div id="scores-list"></div>
    <div id="scores-host-area" style="display:none">
      <button class="btn btn-primary" onclick="playAgain()">ğŸ” Ø¬ÙˆÙ„Ø© Ø«Ø§Ù†ÙŠØ©</button>
    </div>
    <div id="scores-wait-area" class="waiting" style="display:none">
      <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      <p>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...</p>
    </div>
    <button class="btn btn-ghost" onclick="goHome()">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JSONBin Storage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BIN_ID  = '699f6311d0ea881f40d97019';
const API_KEY = '$2a$10$jfFgU1HUzC5MwxyMZnXTzeR0X3YMOUHoaj7zrX5yXjoSe56rQmWky';
const BASE    = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

async function dbGet(retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      const r = await fetch(`${BASE}/latest`, {
        headers: { 'X-Master-Key': API_KEY, 'X-Bin-Meta': 'false' }
      });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      // JSONBin returns {record: {...}} or directly the object
      return j.record !== undefined ? j.record : j;
    } catch(e) {
      console.warn(`dbGet attempt ${i+1} failed:`, e);
      if (i < retries - 1) await sleep(500);
    }
  }
  return {};
}

async function dbSet(data, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      const r = await fetch(BASE, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
        body: JSON.stringify(data)
      });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return true;
    } catch(e) {
      console.warn(`dbSet attempt ${i+1} failed:`, e);
      if (i < retries - 1) await sleep(500);
    }
  }
  return false;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function roomGet(code) {
  const db = await dbGet();
  console.log('ğŸ“¦ DB contents:', JSON.stringify(Object.keys(db)));
  const found = db[code] || null;
  console.log(`ğŸ” Room ${code}:`, found ? 'Ù…ÙˆØ¬ÙˆØ¯Ø© âœ…' : 'Ù…Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø© âŒ');
  return found;
}

async function roomSet(code, roomData) {
  // Read â†’ modify â†’ write with a small delay to avoid conflicts
  await sleep(100);
  const db = await dbGet();
  db[code] = roomData;
  const ok = await dbSet(db);
  if (!ok) console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØºØ±ÙØ©', code);
  return ok;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Game State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AVATARS = ['ğŸ˜','ğŸ¤©','ğŸ˜‚','ğŸ¥³','ğŸ˜','ğŸ¤”','ğŸ˜œ','ğŸ™ƒ','ğŸ¦Š','ğŸ¯'];
const STORIES_PER_PLAYER = 4;

let myName = '', roomCode = '', amHost = false, room = null;
let myStories = [], currentStoryNum = 0, guessedThisRound = false;
let shuffledOpts = [], lastStoryIdx = -1, pollTimer = null;
let currentScreen = 'home';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  currentScreen = name;
}

function showErr(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Polling
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startPoll(code) {
  stopPoll();
  pollTimer = setInterval(async () => {
    const r = await roomGet(code);
    if (r) applyRoomState(r);
  }, 3000);
}
function stopPoll() {
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Apply Room State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyRoomState(r) {
  room = r;

  if (r.phase === 'lobby' && currentScreen === 'lobby') {
    renderLobby();
  }

  if (r.phase === 'lobby' && currentScreen === 'scores') {
    lastStoryIdx = -1;
    renderLobby();
    showScreen('lobby');
    startPoll(roomCode);
  }

  if (r.phase === 'writing' && currentScreen !== 'write') {
    myStories = []; currentStoryNum = 0;
    renderWrite();
    showScreen('write');
  }

  if (r.phase === 'writing' && amHost) {
    const totalExpected = r.players.length * STORIES_PER_PLAYER;
    const allDone = r.players.every(p => (p.storiesSubmitted || 0) >= STORIES_PER_PLAYER);
    if (allDone && r.stories.length >= totalExpected) {
      autoStartGuessing();
    }
    if (currentStoryNum >= STORIES_PER_PLAYER) updateWriteWait();
  }

  if (r.phase === 'guessing') {
    const idx = r.currentStory;
    if (idx !== lastStoryIdx || currentScreen !== 'guess') {
      lastStoryIdx = idx;
      guessedThisRound = false;
      shuffledOpts = [...r.players].sort(() => Math.random() - 0.5);
      renderGuess();
      showScreen('guess');
    } else {
      updateGuessVoteCount();
    }
  }

  if (r.phase === 'scores' && currentScreen !== 'scores') {
    stopPoll();
    renderScores();
    showScreen('scores');
  }
}

async function autoStartGuessing() {
  const fresh = await roomGet(roomCode);
  if (!fresh || fresh.phase !== 'writing') return;
  const totalExpected = fresh.players.length * STORIES_PER_PLAYER;
  if (fresh.stories.length < totalExpected) return;
  fresh.shuffledStories = [...fresh.stories].sort(() => Math.random() - 0.5);
  fresh.currentStory = 0;
  fresh.phase = 'guessing';
  fresh.guesses = {};
  await roomSet(roomCode, fresh);
  room = fresh;
  lastStoryIdx = 0;
  guessedThisRound = false;
  shuffledOpts = [...fresh.players].sort(() => Math.random() - 0.5);
  renderGuess();
  showScreen('guess');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Create Room
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function createRoom() {
  const name = document.getElementById('home-name').value.trim();
  if (!name) { showErr('home-err', 'âš ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  const code = Math.floor(1000 + Math.random() * 9000).toString();
  const r = {
    code, host: name, phase: 'lobby',
    players: [{name, avatar: AVATARS[0], storySubmitted: false}],
    stories: [], shuffledStories: [], scores: {[name]: 0},
    currentStory: 0, guesses: {}, created: Date.now()
  };
  await roomSet(code, r);
  myName = name; roomCode = code; amHost = true; room = r;
  renderLobby();
  showScreen('lobby');
  startPoll(code);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Join Room
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function joinRoom() {
  const name = document.getElementById('home-name').value.trim();
  const code = document.getElementById('home-code').value.trim();
  if (!name) { showErr('home-err', 'âš ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  if (code.length !== 4) { showErr('home-err', 'âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© (4 Ø£Ø±Ù‚Ø§Ù…)'); return; }
  const r = await roomGet(code);
  if (!r) { showErr('home-err', 'âŒ Ø§Ù„ØºØ±ÙØ© Ù…Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©'); return; }
  if (r.phase !== 'lobby') { showErr('home-err', 'âš ï¸ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª'); return; }
  if (r.players.find(p => p.name === name)) { showErr('home-err', 'âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ØŒ ØºÙŠÙ‘Ø± Ø§Ø³Ù…Ùƒ'); return; }
  const avatar = AVATARS[r.players.length % AVATARS.length];
  r.players.push({name, avatar, storySubmitted: false});
  r.scores[name] = 0;
  await roomSet(code, r);
  myName = name; roomCode = code; amHost = false; room = r;
  renderLobby();
  showScreen('lobby');
  startPoll(code);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render Lobby
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLobby() {
  const r = room;
  document.getElementById('lobby-code').textContent = roomCode;
  document.getElementById('lobby-count').textContent = r?.players?.length || 0;
  const list = document.getElementById('lobby-players');
  list.innerHTML = '';
  (r?.players || []).forEach(p => {
    const div = document.createElement('div');
    div.className = 'player-item';
    div.innerHTML = `
      <div class="player-avatar">${p.avatar}</div>
      <div class="player-name">${p.name}</div>
      <span style="font-size:12px;color:${p.name===r.host?'var(--yellow)':'var(--teal)'}">
        ${p.name===r.host ? 'ğŸ‘‘ Ù…Ø¶ÙŠÙ' : 'âœ… Ø¬Ø§Ù‡Ø²'}
      </span>`;
    list.appendChild(div);
  });
  if (amHost) {
    document.getElementById('lobby-host-area').style.display = 'block';
    document.getElementById('lobby-wait-area').style.display = 'none';
    const btn = document.getElementById('start-btn');
    if (!r || r.players.length < 2) {
      btn.disabled = true; btn.textContent = 'â³ Ø§Ù†ØªØ¸Ø± Ù„Ø§Ø¹Ø¨ Ø«Ø§Ù†ÙŠ...';
    } else {
      btn.disabled = false; btn.textContent = `ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© (${r.players.length} Ù„Ø§Ø¹Ø¨ÙŠÙ†)`;
    }
  } else {
    document.getElementById('lobby-host-area').style.display = 'none';
    document.getElementById('lobby-wait-area').style.display = 'block';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Start Game
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startGame() {
  const r = await roomGet(roomCode);
  if (!r) return;
  r.phase = 'writing'; r.stories = []; r.shuffledStories = []; r.guesses = {}; r.currentStory = 0;
  r.players.forEach(p => { p.storiesSubmitted = 0; r.scores[p.name] = 0; });
  await roomSet(roomCode, r);
  room = r; myStories = []; currentStoryNum = 0;
  renderWrite(); showScreen('write');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render Write
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWrite() {
  document.getElementById('write-name-badge').textContent = 'ğŸ‘¤ ' + myName;
  const done = currentStoryNum >= STORIES_PER_PLAYER;
  document.getElementById('write-input-area').style.display = done ? 'none' : 'block';
  document.getElementById('write-wait-area').style.display = done ? 'block' : 'none';
  if (!done) {
    document.getElementById('story-input').value = '';
    document.getElementById('write-story-counter').textContent = `Ø§Ù„Ø³Ø§Ù„ÙØ© ${currentStoryNum + 1} Ù…Ù† ${STORIES_PER_PLAYER}`;
    const isLast = currentStoryNum === STORIES_PER_PLAYER - 1;
    document.getElementById('submit-story-btn').textContent = isLast ? 'Ø¥Ø±Ø³Ø§Ù„ Ø¢Ø®Ø± Ø³Ø§Ù„ÙØ© âœ“' : `Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„ØªØ§Ù„ÙŠ (${currentStoryNum + 1}/${STORIES_PER_PLAYER}) â†’`;
  }
}
function updateWriteWait() {
  if (!room) return;
  const done = room.players.filter(p => (p.storiesSubmitted || 0) >= STORIES_PER_PLAYER).length;
  document.getElementById('write-wait-text').textContent =
    `Ø£Ø±Ø³Ù„Øª ÙƒÙ„ Ø³ÙˆØ§Ù„ÙÙƒ! Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù‚ÙŠØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†... (${done}/${room.players.length})`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Submit Story
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitStory() {
  const text = document.getElementById('story-input').value.trim();
  if (text.length < 10) { showErr('write-err', 'âš ï¸ Ø§ÙƒØªØ¨ Ø³Ø§Ù„ÙØ© Ø£Ø·ÙˆÙ„ Ø´ÙˆÙŠ!'); return; }
  const r = await roomGet(roomCode);
  if (!r) return;
  r.stories.push({player: myName, text});
  const me = r.players.find(p => p.name === myName);
  if (me) me.storiesSubmitted = (me.storiesSubmitted || 0) + 1;
  await roomSet(roomCode, r);
  room = r;
  myStories.push(text);
  currentStoryNum++;
  renderWrite();
  if (currentStoryNum >= STORIES_PER_PLAYER) updateWriteWait();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render Guess
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGuess() {
  if (!room) return;
  const idx = room.currentStory;
  const story = room.shuffledStories?.[idx];
  const total = room.shuffledStories?.length || 1;
  document.getElementById('guess-round-label').textContent = `Ø³Ø§Ù„ÙØ© ${idx+1} Ù…Ù† ${total}`;
  document.getElementById('guess-story-text').textContent = story?.text || '';
  const opts = document.getElementById('guess-options');
  opts.innerHTML = '';
  shuffledOpts.forEach((p, i) => {
    const btn = document.createElement('button');
    btn.className = 'guess-btn';
    btn.style.animationDelay = `${i*0.05}s`;
    btn.innerHTML = `<span class="guess-num">${i+1}</span>${p.name}`;
    if (!guessedThisRound) btn.onclick = () => makeGuess(p.name);
    else {
      btn.disabled = true;
      const correct = story?.player;
      if (p.name === correct) { btn.classList.add('correct'); btn.innerHTML += '<span style="margin-right:auto">âœ“</span>'; }
      const myGuess = room.guesses?.[idx]?.[myName];
      if (p.name === myGuess && p.name !== correct) btn.classList.add('wrong');
    }
    opts.appendChild(btn);
  });
  document.getElementById('guess-toast').classList.remove('show','win','lose');
  document.getElementById('guess-next-host').style.display = 'none';
  document.getElementById('guess-next-wait').style.display = 'none';
  updateGuessVoteCount();
}

function updateGuessVoteCount() {
  if (!room) return;
  const idx = room.currentStory;
  const voters = room.players.length - 1;
  const guessCount = Object.keys(room.guesses?.[idx] || {}).length;
  if (guessedThisRound) {
    document.getElementById('guess-vote-count').textContent = `Ø®Ù…Ù‘Ù† ${guessCount}/${voters}`;
    const total = room.shuffledStories?.length || 1;
    const nextBtn = document.getElementById('next-btn');
    if (nextBtn) nextBtn.textContent = idx+1 < total ? 'Ø§Ù„ØªØ§Ù„ÙŠ â†' : 'ğŸ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬';
    if (amHost) {
      document.getElementById('guess-next-host').style.display = 'block';
    } else if (guessCount >= voters) {
      document.getElementById('guess-next-wait').style.display = 'block';
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Make Guess
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function makeGuess(guessed) {
  if (guessedThisRound || !room) return;
  guessedThisRound = true;
  const idx = room.currentStory;
  const correct = room.shuffledStories?.[idx]?.player;
  const fresh = await roomGet(roomCode);
  if (!fresh.guesses) fresh.guesses = {};
  if (!fresh.guesses[idx]) fresh.guesses[idx] = {};
  fresh.guesses[idx][myName] = guessed;
  if (guessed === correct && myName !== correct)
    fresh.scores[myName] = (fresh.scores[myName] || 0) + 1;
  await roomSet(roomCode, fresh);
  room = fresh;

  // Update buttons
  document.querySelectorAll('.guess-btn').forEach((btn, i) => {
    btn.onclick = null; btn.disabled = true;
    const p = shuffledOpts[i];
    if (p.name === correct) { btn.classList.add('correct'); btn.innerHTML = `<span class="guess-num">${i+1}</span>${p.name}<span style="margin-right:auto">âœ“</span>`; }
    if (p.name === guessed && p.name !== correct) btn.classList.add('wrong');
  });

  const toast = document.getElementById('guess-toast');
  if (guessed === correct) {
    toast.textContent = `âœ… ØµØ­! Ø§Ù„Ø³Ø§Ù„ÙØ© Ù„Ù€ ${correct} ğŸ‰`; toast.className = 'toast show win';
  } else {
    toast.textContent = `âŒ ØºÙ„Ø·! Ø§Ù„Ø³Ø§Ù„ÙØ© ÙƒØ§Ù†Øª Ù„Ù€ ${correct} ğŸ˜…`; toast.className = 'toast show lose';
  }
  updateGuessVoteCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Next Round
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function nextRound() {
  if (!amHost) return;
  const r = await roomGet(roomCode);
  const nextIdx = r.currentStory + 1;
  if (nextIdx >= r.shuffledStories.length) {
    r.phase = 'scores';
    await roomSet(roomCode, r);
    room = r; stopPoll(); renderScores(); showScreen('scores');
  } else {
    r.currentStory = nextIdx; r.phase = 'guessing';
    await roomSet(roomCode, r);
    room = r; lastStoryIdx = nextIdx; guessedThisRound = false;
    shuffledOpts = [...r.players].sort(() => Math.random() - 0.5);
    renderGuess(); showScreen('guess');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render Scores
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderScores() {
  const sorted = Object.entries(room.scores || {}).sort((a,b) => b[1]-a[1]);
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  document.getElementById('winner-line').textContent = sorted[0] ? `ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø²: ${sorted[0][0]}!` : '';
  const list = document.getElementById('scores-list');
  list.innerHTML = '';
  sorted.forEach(([name, pts], i) => {
    const div = document.createElement('div');
    div.className = 'score-item' + (i===0?' first':'');
    div.style.animationDelay = `${i*0.08}s`;
    div.innerHTML = `<span class="score-medal">${medals[i]||'ğŸ–ï¸'}</span><span class="score-name">${name}</span><span class="score-pts">${pts} Ù†Ù‚Ø·Ø©</span>`;
    list.appendChild(div);
  });
  document.getElementById('scores-host-area').style.display = amHost ? 'block' : 'none';
  document.getElementById('scores-wait-area').style.display = amHost ? 'none' : 'block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Play Again
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function playAgain() {
  const r = await roomGet(roomCode);
  r.phase='lobby'; r.stories=[]; r.shuffledStories=[]; r.guesses={}; r.currentStory=0;
  r.players.forEach(p => { p.storiesSubmitted=0; r.scores[p.name]=0; });
  await roomSet(roomCode, r);
  room=r; lastStoryIdx=-1; myStories=[]; currentStoryNum=0;
  renderLobby(); showScreen('lobby'); startPoll(roomCode);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Go Home
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goHome() {
  stopPoll();
  myName=''; roomCode=''; amHost=false; room=null;
  document.getElementById('home-name').value='';
  document.getElementById('home-code').value='';
  lastStoryIdx=-1; showScreen('home');
}

function copyCode() {
  navigator.clipboard.writeText(roomCode).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'âœ“ ØªÙ…';
    setTimeout(() => btn.textContent = 'Ù†Ø³Ø®', 2000);
  });
}
</script>

</body>
</html>
